"use strict";define("recommendations/models",["backbone","moment","core/time"],function(a,b,c){var d=function(a){var d=a.prototype;return a.extend({defaults:{sourceThreadId:null,forumId:null,forum:null,threadForum:null,requestBin:null,createdAgo:!1},initialize:function(a,d){if(this.set("threadForum",a.forum),d&&d.humanFriendlyTimestamp){var e=c.assureTzOffset(this.get("createdAt"));e=b(e,c.ISO_8601),this.set("createdAgo",e.fromNow())}},toJSON:function(){var a=d.toJSON.call(this);return a.preview&&(a.preview=a.preview.toJSON()),a},toString:function(){return"organic link: "+this.get("title")+" "+this.get("link")+" (id = "+this.id+")"}})}(a.Model);return{RelatedThread:d}}),define("recommendations/collections",["underscore","backbone","loglevel","moment","core/api","core/utils/html","recommendations/models"],function(a,b,c,d,e,f,g){var h=b.Collection.extend({url:e.getURL("discovery/listTopPost.json"),parse:function(a){for(var c=b.Collection.prototype.parse.call(this,a),d=0,e=c.length;d<e;d++)c[d].plaintext=f.stripTags(c[d].message);return c}}),i=b.Collection.extend({url:e.getURL("discovery/listRecommendations.json"),initialize:function(a,b){this.model=g.RelatedThread,this.name=b.name,this.minLength=b.minLength,this.maxLength=b.maxLength,this.settings=b.settings,this.forumUrl=b.forumUrl,this.homeDiscoveryEnabled=0},addClickMetadata:function(a){this.invoke("set",a)},fetch:function(a,e){a.data.limit=2*this.maxLength,a.data.homeDiscoveryEnabled=this.homeDiscoveryEnabled&&"1",this.settings.maxAgeDays>0&&(a.data.since=d().subtract(this.settings.maxAgeDays,"days").toISOString());var f=Promise.resolve(b.Collection.prototype.fetch.call(this,a)),g=this;return e&&(f=f.then(function(){return g.getContentPreviews()["catch"](function(a){c.info("There was a problem getting snippets: ",a)})})),f},parse:function(a){var c=this,d=b.Collection.prototype.parse.call(this,a);return c.forumUrl?(c.forumUrl=c.forumUrl.replace(/(^\w+:|^)\/\//,""),d.filter(function(a){return Boolean(a.id)&&Boolean(a.title)&&Boolean(a.description)&&Boolean(a.url)&&a.url.indexOf(c.forumUrl)>-1})):d},getContentPreviews:function(){var b=this.map(function(a){return parseInt(a.get("id"),10)});if(b.length<this.minLength)return Promise.resolve();b.sort(function(a,b){return a-b});var c=Promise.resolve(this.previews.fetch({data:{thread:b},timeout:i.CONTENT_PREVIEWS_FETCH_TIMEOUT}));return c.then(a.bind(this.attachPreviews,this))},attachPreviews:function(){this.previews.each(function(a){var b=a.get("thread"),c=this.get(b);c&&c.set("preview",a)},this)}},{CONTENT_PREVIEWS_FETCH_TIMEOUT:5e3}),j={PostCollection:h,RelatedThreadCollection:i};return j}),define("recommendations/exceptions",[],function(){var a=function(a,b){var c=function(){var c=Error.apply(this,arguments);return c.name=this.name=a,this.disqusCode=b||"uncaught",this.message=c.message,this.stack=c.stack,this},d=function(){};return d.prototype=Error.prototype,c.prototype=new d,c};return{NoAds:a("NoAds","no_ads"),NoBinError:a("NoBinError","no_bin"),AdsExhaustedError:a("AdsExhaustedError","ads_exhausted"),RenderError:a("RenderError","render_error"),FetchError:a("FetchError","fetch_error"),TimeoutError:a("TimeoutError","timeout"),ValidationError:a("ValidationError","validation_error"),AdBlockError:a("AdBlockError","ad_block")}}),define("recommendations/helpers",["underscore","jquery","loglevel"],function(a,b,c){var d=function(d,e){function f(){return j.scrollHeight-j.offsetHeight>.2*k}function g(){i.lastChild&&!a.contains(["...","…"],i.lastChild.nodeValue)&&(l=i.appendChild(window.document.createTextNode(" "+o)),f()&&(i.removeChild(l),i.removeChild(i.lastChild),g()))}if(!d.closest("body").length)return void c.info("lineTruncate called on el not on DOM");if(d.text().length<1)return void c.info("lineTruncated called on empty el");var h=function(a){return 3!==a.nodeType};if(a.any(d.children(),h))return void c.info("lineTruncate called on non-flat el");var i=d[0],j=i;if("block"!==d.css("display"))for(;j.parentNode&&(j=j.parentNode,"block"!==b(j).css("display")););var k=parseFloat(d.parent().css("font-size"),10);if(f()){e=e||{};var l,m,n=e.lines||1,o=e.ellipsis,p=d.text();if(p.length){var q=d.width()/k,r=parseInt(q*n,10),s=p.split(/\s/),t=0;d.empty();var u=s.length;for(m=0;m<u&&(t+=s[m].length+1,!(t>=r));m++)0!==m&&(s[m]=" "+s[m]),i.appendChild(window.document.createTextNode(s[m]));if(f())for(;i.lastChild&&f();)l=i.removeChild(i.lastChild);else{do l=i.appendChild(window.document.createTextNode(" "+s[m])),m+=1;while(!f()&&m<u);i.removeChild(l)}o&&(a.isString(o)||(o="…"),g())}}},e=["product","zone","service","experiment","variant"],f=function(b){b=b||"";var c=a.object(e,b.split(":"));return{bin:b,experiment:c.experiment||"",variant:c.variant||""}};return{lineTruncate:d,binToEventParams:f}});var _extends=Object.assign||function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c)Object.prototype.hasOwnProperty.call(c,d)&&(a[d]=c[d])}return a};define("templates/recommendations/recommendationsCollection",["underscore","react","core/strings","core/utils/object/get"],function(a,b,c,d){var e=c.gettext,f=function(a){return b.createElement("div",{className:"content-preview-wrapper"},b.createElement("div",{className:"recommend-content"},a.settings.titleHidden||!a.settings.disableOverlay?b.createElement("span",{"data-role":"recommend-description-snippet",className:"line-truncate","data-line-truncate":"5"},a.description):b.createElement("h3",{className:"recommend-post-title",title:a.title},b.createElement("span",{"data-role":"recommend-thread-title",className:"title line-truncate","data-line-truncate":3,"data-content":a.title,dangerouslySetInnerHTML:{__html:a.title}}))))},g=function(a){return b.createElement("div",{className:"top-comment","data-role":"recommend-top-comment"},b.createElement("div",{className:"top-comment-header"},b.createElement("span",{className:"top-comment-avatar-wrapper"},b.createElement("img",{"data-src":d(a.preview,["author","avatar","cache"],""),alt:e("Avatar"),"data-role":"recommend-avatar"})),b.createElement("span",{className:"user publisher-color","data-role":"recommend-top-comment-author"},d(a.preview,["author","name"],null))),b.createElement("div",{className:"recommend-top-comment-wrapper"},b.createElement("span",{"data-role":"recommend-top-comment-snippet",className:"line-truncate","data-line-truncate":"3",dangerouslySetInnerHTML:{__html:d(a.preview,["message"],null)}})))},h=function(c){return a.map(c.collection,function(a,h){return b.createElement("div",{className:"recommend-post post-"+h,id:"recommend-link-"+a.domIdSuffix,"data-role":"recommended-post","data-link":a.discoveryLink},b.createElement("header",{className:"recommend-post-header"},b.createElement("div",{className:"recommend-image-wrapper"},b.createElement("img",{src:a.images[0].url,alt:a.title,title:a.title}),b.createElement("span",{className:"overlay"})),c.settings.disableOverlay?null:b.createElement("h3",{className:"recommend-post-title",title:a.title},b.createElement("span",{"data-role":"recommend-thread-title",className:"title line-truncate","data-line-truncate":d(c.settings,["numLinesHeadline"],""),"data-content":a.title,dangerouslySetInnerHTML:{__html:a.title}}))),b.createElement("ul",{className:"meta"},c.settings.homeDiscoveryEnabled?b.createElement("li",null,a.forumName):null,c.settings.metaDate&&!c.settings.homeDiscoveryEnabled?b.createElement("li",{className:"time"},a.createdAgo):null," ",c.settings.metaComments&&a.posts>0?b.createElement("li",{className:"comments"},1===a.posts?e("1 comment"):e("%(numPosts)s comments",{numPosts:a.posts})," "):null),c.settings.contentPreview?b.createElement(f,_extends({settings:c.settings},a)):null,c.settings.featuredComment&&!c.settings.contentPreview?b.createElement(g,a):null)})};return h}),define("recommendations/views/links/BaseCollectionView",["underscore","jquery","backbone","react","react-dom","common/urls","recommendations/helpers","templates/recommendations/recommendationsCollection"],function(a,b,c,d,e,f,g,h){var i=c.View.extend({events:{"click [data-redirect]":"handleClick"},handleClick:function(a){this.swapHref(a.currentTarget)},swapHref:function(b){b.setAttribute("data-href",b.getAttribute("href")),b.setAttribute("href",b.getAttribute("data-redirect")),a.delay(function(){b.setAttribute("href",b.getAttribute("data-href"))},100)},initialize:function(a){this.elementsSelector="div.recommend-post",this.$elements=this.$el.find(this.elementsSelector),this.initContext=a.context,this.settings=a.settings;var b=this.collection;this.listenTo(b,{remove:this.remove,reset:this.render})},truncate:function(){var c=this.$el.find(".line-truncate");a.each(c,function(a){var c=b(a);g.lineTruncate(c,{lines:parseInt(c.attr("data-line-truncate"),10),ellipsis:!0})})},metaPlacement:function(){var c=this.$el.find(".meta"),d=this.$el.find(".recommend-post-title");"absolute"===b(c[0]).css("position")&&a.each(c,function(a,c){var e="10px";if(d.length){var f=b(d[c]),g=parseInt(f.context.offsetHeight,10),h=Math.ceil(parseFloat(f.css("line-height"))),i=5;e=(h/2+g+i).toString()+"px"}b(a).css({bottom:e})})},resizeImage:function(a){var b=200,c=192,d=0,e=a.images[0];return e.width>b&&e.height>c?e.height<e.width?(d=c/e.height,e.height=c,e.width*=d,e.url+="&h="+e.height):(d=b/e.width,e.width=b,e.height*=d,e.url+="&w="+e.width):e.size||(e.url+="&h="+c),a.image=e,a},getTemplateContext:function(){this.appContext||(this.appContext=this.model.app.toJSON()),this.settings=a.extend(this.settings,this.appContext);var b=a.extend({settings:this.settings},this.initContext);b.collection=this.collection.toJSON();var c=a.bind(this.resizeImage);b.collection=b.collection.reduce(function(a,b){return b.images.length>0&&a.push(c(b)),a},[]);var d=this.collection.at(0);if(d){var e=d.has("id")?"organic-":"promoted-",g=d.idAttribute,h=this.model.app.get("homeDiscoveryEnabled")&&!1;a.each(b.collection,function(a){a.advertisement_id=a[g],a.domIdSuffix=a[g],a.domIdSuffix=e+a.domIdSuffix,a.discoveryLink=h?f.home+"discussion/"+a.forum+"/"+a.slug:a.url})}return b},render:function(){var a=this.getTemplateContext();return this.el.children.length||e.render(d.createElement(h,a),this.el),this.$elements=this.$el.find(this.elementsSelector),this.truncate(),this.metaPlacement(),this},remove:function(d,e,f){if(0===arguments.length)return c.View.prototype.remove.call(this);var g=a.toArray(this.$elements),h=g.splice(f.index,1)[0];return b(h).remove(),this.$elements=b(g),this}});return i}),define("templates/recommendations/recommendationsMain",["underscore","react","core/strings","core/utils/object/get"],function(a,b,c,d){var e=c.gettext,f=function(c){var f=c.settings.contentPreview?"":"no-preview";f=c.settings.titleHidden||!c.settings.disableOverlay?f:"has-preview-title";var g=c.settings.metaDate||c.settings.metaComments?"":"no-meta";return b.createElement("div",{id:c.id,className:"recommend-main "+f+" "+g},a.map(c.sections,function(a){return b.createElement("section",{id:a.id,className:a.className},b.createElement("header",{className:"recommend-col-header"},b.createElement("h2",null,e("Also on %(forumName)s",{forumName:b.createElement("strong",null,c.homeDiscoveryEnabled?"Disqus":d(c.forum,["name"],null))}))),b.createElement("button",{className:"scroll-btn scroll-left","data-action":"scroll-left"},"❮"),b.createElement("div",{className:"recommend-wrapper"},b.createElement("div",{className:"recommend-posts","data-role":"recommend-posts"})),b.createElement("button",{className:"scroll-btn scroll-right","data-action":"scroll-right"},"❯"))}))};return f}),define("recommendations/views/links/MainView",["jquery","underscore","backbone","core/bus","recommendations/views/links/BaseCollectionView","templates/recommendations/recommendationsMain"],function(a,b,c,d,e,f){var g=c.View.extend({events:{"click [data-role=recommended-post]":"handleClick","click [data-action=scroll-left]":"clickScrollLeft","click [data-action=scroll-right]":"clickScrollRight"},topEdgeOffset:0,bottomEdgeOffset:1/0,handleClick:function(b){var c=a(b.currentTarget),e=c.data("link");d.trigger("uiAction:recommendationsClick",e),b.stopPropagation(),window.open(e,"_blank")},clickScrollLeft:function(){this.scroll(-1)},clickScrollRight:function(){this.scroll(1)},scroll:function(b){var c=a(this.$el.find(".recommend-wrapper")[0]),d=a(this.$el.find(".recommend-posts")[0]),e=this.$el.find(".recommend-post").length,f=d.width()/e,g=2*f,h=700;c.width()<g&&(g=f,h/=2);var i=c.scrollLeft()+g*b;c.animate({scrollLeft:i},h)},createSections:function(){var a=this.model,c=a.get("sectionNames"),d=a.get("sectionIds");return b.map(a.collections,function(a,b){return{id:d[b],className:c[b],collection:a}})},getTemplateContext:function(){var a=this.model.app,b=this.createSections();return{id:a.get("innerContainerId"),sections:b,forum:a.get("sourceForum"),homeDiscoveryEnabled:a.get("homeDiscoveryEnabled")}},render:function(){var c=this;return c.model.validateData(),c.renderViews(),c.resizeHandler=b.debounce(function(){c.views&&b.invoke(c.views,"render")},100),a(window).on("resize",c.resizeHandler),this},renderViews:function(){var c=this.getTemplateContext(),d=this;c.settings=d.model.threads.settings,this.$el.html(f(c)),this.$el.addClass("recommendations-wrapper");var g=b.map(c.sections,function(b){return new e({model:d.model,collection:b.collection,settings:c.settings,el:a("#"+b.id+" [data-role=recommend-posts]"),context:{}})}),h=this.$el.width();this.$el.width(h-20),b.invoke(g,"render"),this.$el.width("100%");var i=g[0].$el.width();i<=h&&this.$el.find(".scroll-btn").hide(),this.views=g},remove:function(){c.View.prototype.remove.call(this),this.resizeHandler&&a(window).off("resize",this.resizeHandler)}});return g}),define("recommendations/views/Placement",["backbone","recommendations/exceptions","recommendations/views/links/MainView"],function(a,b,c){var d=a.View.extend({className:"post-list",LAYOUT_TO_CLASS:{links:c},initialize:function(a){a=a||{},this.placement=a.placement,this.settings=a.settings,this.sourceThreadUrl=a.sourceThreadUrl,this._enabled=!0,this._collapse()},setRequestBin:function(a){this._bin=a},tryAd:function(a){this._unsetAd();var c=a.get("layout"),d=this.LAYOUT_TO_CLASS[c];return d?(a.state.set("placement",this.placement),this._adView=new d({model:a,settings:this.settings,sourceThreadUrl:this.sourceThreadUrl}),this.$el.html(this._adView.el),this._adView.render(),void this._expand()):Promise.reject(new b.ValidationError('Specified ad layout "'+c+'" was not found.'))},getCurrentUnit:function(){return this._adView},disable:function(){this._enabled=!1,this._collapse()},enable:function(){this._enabled=!0,this._expand()},remove:function(){return this._unsetAd(),a.View.prototype.remove.apply(this,arguments)},_unsetAd:function(){this._adView&&(this._adView.model.state.unset("placement"),this._adView.remove(),this._adView=null)},_expand:function(){this._enabled&&this.$el.css({height:"auto",visibility:"visible"})},_collapse:function(){this.$el.css({height:0,visibility:"hidden"})}});return d}),define("recommendations/models/State",["backbone"],function(a){var b={UNTOUCHED:1,PROCESSING:2,DONE:4};return a.Model.extend({defaults:{status:b.UNTOUCHED,placement:null,error:null},isResolved:function(){return this.isDone()&&!this.get("error")},isRejected:function(){return this.isDone()&&this.get("error")},isDone:function(){return this.get("status")===b.DONE}},{STATUS:b})}),define("recommendations/models/SponsoredLinkAd",["underscore","backbone","core/analytics/jester","common/Session","recommendations/helpers","recommendations/exceptions","recommendations/models/State"],function(a,b,c,d,e,f,g){return b.Model.extend({idAttribute:"layout",initialize:function(b,c){var d=this;d.threads=c.threads,d.collections=[],d.app=c.app,a.bindAll(d,"validateCollectionMin","prepareData"),d.set("sectionNames",["col-organic"]),d.set("sectionIds",a.map(d.get("sectionNames"),function(a){return a+"-"+d.cid})),d.collections.push(this.threads),this.state=new g,d.threads&&d.threads.each(function(a){a.state=d.state})},hasData:function(){return a.some(this.collections,function(a){return a.length})},validateCollectionMin:function(){for(var b,c,d=this.collections,e=this.get("sectionNames").slice(0),f=this.get("sectionIds").slice(0),g=d.length;g>0;)g-=1,b=d[g],c=b.minLength,b.length<c&&(d.splice(g,1),e.splice(g,1),f.splice(g,1),g=d.length);if(a.isNumber(this.app.get("numColumns"))&&a.isNumber(this.app.get("minPerColumn"))){var h=this.app.get("numColumns")*this.app.get("minPerColumn"),i=a.reduce(d,function(a,b){return a+b.length},0);i<h&&(d.splice(0,d.length),e.splice(0,e.length),f.splice(0,f.length))}this.set("sectionNames",e),this.set("sectionIds",f)},prepareData:function(){var a=this.commonClickMetadata();this.threads.addClickMetadata(a)},trimOrganic:function(){var a=this.threads;a.length>a.maxLength&&a.reset(a.slice(0,a.maxLength))},validateData:function(){var a=this;if(a.threads.maxLength=a.app.getCollectionMax("Organic"),this.validateCollectionMin(),this.prepareData(),!a.hasData())throw new f.ValidationError("Not enough data")},commonClickMetadata:function(){var a=this.app,b=a.get("sourceForum"),c={sourceThreadId:a.get("sourceThread").id,forumId:b.pk,forum:b.id,requestBin:a.get("requestBin")};return d.isKnownToBeLoggedOut()||(c.userId=d.fromCookie().id),c},report:function(b){a.isEmpty(b)||c.client.emit(a.extend(this.snapshot(),b))},snapshot:function(){var b=this.threads,c=this.app,f=e.binToEventParams(c.get("requestBin")),g=d.isKnownToBeLoggedOut()?{}:{userId:d.fromCookie().id},h=a.extend({internal_organic:b&&b.length,external_organic:0,promoted:0,display:!0,placement:this.state.get("placement"),zone:"thread",area:this.state.get("placement"),thread_id:c.get("sourceThread").id,forum_id:c.get("sourceForum").pk},g,f,{object_type:"link"});return h}})}),define("recommendations/main",["backbone","underscore","jquery","loglevel","common/Session","core/api","recommendations/collections","recommendations/views/Placement","recommendations/models/SponsoredLinkAd"],function(a,b,c,d,e,f,g,h,i){var j={},k=1e4;return j.RecommendationsApp=a.Model.extend({defaults:{name:"default",featuredComments:!0,sourceThread:null,sourceForum:null,sourceThreadUrl:null,numColumns:2,maxPerColumn:2,maxOrganicTextLinks:4,innerContainerName:"recommend-main",lineTruncationEnabled:!0,numLinesHeadline:3,homeDiscoveryEnabled:void 0},initialize:function(){var a=this;a.session=e.get(),f.call("discovery/details.json",{data:{forum:a.get("sourceForum").id}}).success(function(b){var c=b.response,d={contentPreview:c.content_preview,disableOverlay:c.disable_overlay,titleHidden:c.title_hidden,topPlacement:c.top_placement,metaDate:c.meta_date,metaComments:c.meta_comments,maxAgeDays:c.max_age_days};a.initPlacement(d),a.createDataCollections(d),a.run()}),a.set("innerContainerId",a.get("innerContainerName")+"-"+a.cid)},initPlacement:function(a){this.position=new h({placement:a.topPlacement?"top":"bottom",settings:a}),c("#placement-"+this.position.placement).html(this.position.$el)},createDataCollections:function(a){var b="Organic",c={name:b,minLength:2,maxLength:this.getCollectionMax(b),homeDiscoveryEnabled:!1,settings:a,forumUrl:this.get("sourceForum").url};this.threads=new g.RelatedThreadCollection([],c)},getViewportWidth:function(){return c(window.document).width()},getCollectionMax:function(a){return this.get("max"+a+"TextLinks")},run:function(){var a=this;return a.getDataOrganic().then(function(){return a.threads.length?a.renderOrganicLinks():void d.debug("No organic links, bailing out")})["catch"](function(a){d.debug("Organic-only Discovery failed",a)})},renderOrganicLinks:function(){var a=new i({layout:"links"},{threads:this.threads,app:this});this.position.tryAd(a)},getDataOrganic:function(){var a={timeout:k,data:{thread:this.get("sourceThread").id},reset:!0,humanFriendlyTimestamp:!0};return this.set("featuredComments",!1),this.threads.fetch(a,this.get("featuredComments"))}}),j.init=function(a,c){var d=b.extend({},{sourceThread:a.toJSON(),sourceForum:a.forum.toJSON(),sourceThreadUrl:a.currentUrl||window.document.referrer,service:c.service,experiment:c.experiment,variant:c.variant,homeDiscoveryEnabled:c.homeDiscoveryEnabled}),e=new j.RecommendationsApp(d);return e},j}),define("recommendations.bundle",function(){});